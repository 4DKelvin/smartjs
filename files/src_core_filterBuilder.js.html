<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>src\core\filterBuilder.js - smartjs</title>
  
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="stylesheet" href="../assets/css/custom.css">
    <link rel="stylesheet" href="../assets/vendor/bootstrap/css/bootstrap.css">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
</head>
<body class="yui3-skin-sam">
<div class="navbar navbar-fixed-top">
    <div class="navbar-inner">
        <h1 class="brand" style="padding: 10px 16px 10px; height: 20px; line-height: 20px; margin-left: 0;">
        
	    <img alt="smartjs" src="../assets/css/logo.png" style="max-height: 65%;" title="smartjs">
        
            smartjs
        </h1>
	<div class="nav">
            <li class="divider-vertical"></li>
            <li>
                <p class="navbar-text">
                    API Docs for Version: <b>0.4.0</b>
                </p>
            </li>
        </div>
        <form class="navbar-form pull-right" style="line-height: 40px; height: 40px;">
            <input style="margin-top: 0;" type="text" class="search-query" placeholder="Search for classes/modules..." data-obj='["classes/attachTrigger", "classes/EventArg", "classes/EventArg(flowController)", "classes/EventArg(trigger)", "classes/factory", "classes/FilterBuilder", "classes/flowController", "classes/klass", "classes/klassBase", "classes/Operations", "classes/priorityList", "classes/promiseEvent", "classes/util", "modules/AOP", "modules/FilterBuilder", "modules/OOP", "modules/Util"]'>
        </form>
    </div>
</div>
<div class="container">
    <div class="row">
        <div class="span3">
	    <div>
    <h3>APIs</h3>
    <div id="sidebar">
        <ul id="main-nav" class="nav nav-tabs" style="margin-bottom:0;">
            <li class="active"><a href="#modules" data-toggle="tab">Modules</a></li>
            <li><a href="#classes" data-toggle="tab">Classes</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" placeholder="Type to filter APIs">
        </div>

        <div class="tab-content" style="border: 1px solid #DDD; border-top:0;">
            <div class="tab-pane active" id="modules">
                <ul id="api-modules" class="nav nav-list">
                    
                        <li><a href="../modules/AOP.html">AOP</a></li>
                    
                        <li><a href="../modules/FilterBuilder.html">FilterBuilder</a></li>
                    
                        <li><a href="../modules/OOP.html">OOP</a></li>
                    
                        <li><a href="../modules/Util.html">Util</a></li>
                    
                </ul>
            </div>
            <div class="tab-pane" id="classes">
                <ul id="api-classes" class="nav nav-list">
                    
                        <li><a href="../classes/attachTrigger.html">attachTrigger</a></li>
                    
                        <li><a href="../classes/EventArg.html">EventArg</a></li>
                    
                        <li><a href="../classes/EventArg(flowController).html">EventArg(flowController)</a></li>
                    
                        <li><a href="../classes/EventArg(trigger).html">EventArg(trigger)</a></li>
                    
                        <li><a href="../classes/factory.html">factory</a></li>
                    
                        <li><a href="../classes/FilterBuilder.html">FilterBuilder</a></li>
                    
                        <li><a href="../classes/flowController.html">flowController</a></li>
                    
                        <li><a href="../classes/klass.html">klass</a></li>
                    
                        <li><a href="../classes/klassBase.html">klassBase</a></li>
                    
                        <li><a href="../classes/Operations.html">Operations</a></li>
                    
                        <li><a href="../classes/priorityList.html">priorityList</a></li>
                    
                        <li><a href="../classes/promiseEvent.html">promiseEvent</a></li>
                    
                        <li><a href="../classes/util.html">util</a></li>
                    
                </ul>
            </div>

            
        </div>
    </div>
</div>

        </div>
        <div class="span9">
            <!--     <form id="options-form" class="form-inline pull-right">
        Show:
        <label for="api-show-inherited" class="checkbox">
            <input type="checkbox" id="api-show-inherited" checked>
            Inherited
        </label>

        <label for="api-show-protected" class="checkbox">
            <input type="checkbox" id="api-show-protected">
            Protected
        </label>

        <label for="api-show-private" class="checkbox">
            <input type="checkbox" id="api-show-private">
            Private
        </label>
        <label for="api-show-deprecated" class="checkbox">
            <input type="checkbox" id="api-show-deprecated">
            Deprecated
        </label>

    </form>

 -->
            <div class="apidocs">
                <div id="docs-main">
                    <div class="content">
                        <div class="page-header">
    <h1>src\core\filterBuilder.js <small>File</small></h1>
</div>

<div class="file">
    <pre class="prettyprint linenums" id='src_code'>

/**
    过滤器生成器
    
    Feartures : 
        1. 编译字符串过滤，“name = @name and (age &gt; @age and type = @type)”，生产过滤条件参数或者过滤方法
        2. 参数过滤，以参数的方式全部构建&quot;=&quot;的方式构建查询方法
        3. 方法过滤
        4. 忽略null的条件
        5. 自定义扩展过滤操作符
        6. 条件&amp;参数合并

    Update Note：
        + 2014.7 ：Created

    @module FilterBuilder
*/
stDefine(&#x27;filterBuilder&#x27;, function(st) {
	//空值忽略条件标示符
	var NullIgnoreSign = [&quot;{&quot;, &quot;}&quot;],
		//关系字符
		Relations = [&quot;and&quot;, &quot;or&quot;],
		isArray = $.isArray;

	/**
	 * 过滤生成器对象
	 * @class FilterBuilder
	 * @constructor
	 * @param {string|function|object} filter 三种类型： 
	 * 1. {string}, 查询字符串
	 * 2. {object}, 参数对象
	 * 3. {function}, 过滤方法
	 * @return {FilterBuilder} 返回过滤生成器对象
	 * @example
	 * 		//查询字符串,{age &gt; @age}用{}包含的条件表示当@age为null的时候，忽略此条件
	 * 		var str = &quot;{age &gt; @age} and (role = @sa or role = @coder) and project = @project&quot;;
			
			//创建过滤器
			var filter = st.filterBuilder(str);
			
			//生成过滤方法
			var filterFn = filter.buildFn({
				age : 20,
				sa : &#x27;sa&#x27;,
				coder : &#x27;coder&#x27;,
				project : &quot;smartjs&quot;
			});
			
			//定义数据
			var data = [
					{name: &quot;roy&quot;,age: 30,role: &quot;coder&quot;,project: &quot;smartjs&quot;},
			 		{name: &quot;coder1&quot;, age: 20, role: &quot;coder&quot;, project: &quot;smartjs&quot;}
			];
			
			//过滤数据
			var result = data.filter(filterFn);
	 */
	function FilterBuilder(filter) {
		if (filter) {
			switch (typeof filter) {
				//查询字符串
				case &quot;string&quot;:
					this._conditions = compileStringCondition(filter);
					break;
				//过滤方法
				case &quot;function&quot;:
					this._filter = filter;
					break;
				//参数过滤
				case &quot;object&quot;:
					this._params = filter;
					break;
			}
		}
	}

	FilterBuilder.prototype = {
		/**
		 * 生成条件参数,当使用查询字符串进行构建过滤器时，根据传入的参数值生产最终的带关系和操作过滤参数
		 * @method buildCondition
		 * @param  {object} params 过滤的参数值
		 * @return {object}   条件参数
		 * @example
		 * 		var str = &quot;age &gt; @age and (role = @sa or role = @coder) and project = @project&quot;;
				var filter = st.filterBuilder(str);
		 *
		 * 		//生成条件
		 * 		var conditions = filter.buildCondition({
		 * 			age : 20,
					sa : &#x27;sa&#x27;,
					coder : &#x27;coder&#x27;,
					project : &quot;smartjs&quot;
				})

		 * 		//生成的conditions对象
		 * 		{&quot;and&quot;:[
		 * 			{&quot;field&quot;:&quot;age&quot;,&quot;operation&quot;:&quot;&gt;&quot;,&quot;param&quot;:20},
	 * 				{&quot;or&quot;:[
	 * 					{&quot;field&quot;:&quot;role&quot;,&quot;operation&quot;:&quot;=&quot;,&quot;param&quot;:&quot;sa&quot;},
	 * 					{&quot;field&quot;:&quot;role&quot;,&quot;operation&quot;:&quot;=&quot;,&quot;param&quot;:&quot;coder&quot;}
	 * 				]},
		 * 			{&quot;field&quot;:&quot;project&quot;,&quot;operation&quot;:&quot;=&quot;,&quot;param&quot;:&quot;smartjs&quot;}
		 * 		]}
		 */
		buildCondition: function(params) {
			if (this._conditions)
				return buildConditions(this._conditions, params);
		},
		/**
		 * 生成过滤方法
		 * @method buildFn
		 * @param  {object} [params] 过滤的参数值
		 * @param  {string|function|object} [mergeFilter] 需要合并的过滤条件
		 * @return {function} 过滤方法
		 * @example
		 * 		//创建role的过滤器
		 * 		var filter = st.filterBuilder(&quot;role = @role&quot;);
		 *
		 * 		//传入条件参数，合并age的过滤
		 * 		filter.buildFn({role:&quot;sa&quot;,age:20},&quot;age &gt; @age&quot;)
		 */
		buildFn: function(params, mergeFilter) {
			var self = this,
				conditions, fnFilter, mergeFilterFn;

			//过滤方法模式
			if (self._filter)
				fnFilter = self._filter;
			//条件生成模式
			else if (self._conditions) {
				conditions = this.buildCondition(params);
				if (conditions)
					fnFilter = buildFn(conditions)
			} else if(!mergeFilter)
				//参数过滤非合并参数模式下，根据参数创建过滤方法
				fnFilter = compileObjectCondition(st.mergeObj(params, self._params));

			//存在合并过滤情况下，生成合并过滤方法
			if (mergeFilter) {
				filterType = typeof(mergeFilter);
				if (filterType === &#x27;string&#x27;)
					mergeFilterFn = (new FilterBuilder(mergeFilter)).buildFn(params);
				else if(filterType === &#x27;function&#x27;)
					mergeFilterFn = mergeFilter;
			}
			//合并过滤条件
			return st.mergeFn(fnFilter, mergeFilterFn);
		}
	}

	//将对象参数编译成过滤方法
	function compileObjectCondition(obj) {
		return function(item) {
			var check = true;
			$.each(obj, function(name, value) {
				if (item[name] !== value) {
					check = false;
					return check;
				}
			})
			return check;
		}
	}

	//将过滤字符串编译成过滤条件对象
	function compileStringCondition(filter) {
		var groups = [],
			deep = 0,
			//条件关系链
			chain = [groups];

		filter.split(&#x27;(&#x27;).forEach(function(part, i) {
			if (i === 0) {
				compileGroup(chain, deep, part)
			} else {
				part.split(&#x27;)&#x27;).forEach(function(exp, i) {
					i &gt; 0 ? deep-- : deep++;

					compileGroup(chain, deep, exp);
				})
			}
		})
		return groups.length ? groups : null;
		//console.log(groups);
	}

	//编译查询条件组
	function compileGroup(chain, deep, part) {
		var group, arr, condition, len = chain.length - 1;

		arr = part.split(/\s(or|and)\s/g);
		//判断开始是否存在关系表达式
		if (arr[0].length === 0 &amp;&amp; Relations.indexOf(arr[1]) &gt; -1) {
			arr.shift();
			chain[len].or = arr.shift() === Relations[1];
		}

		//深度大于关系链时，扩展关系链
		if (deep &gt; len)
			group = chain[deep] = [];
		else {
			group = chain[deep];
			//深度小于关系链时，将关系链最后一项清除，添加到当前group中
			deep &lt; len &amp;&amp; group.push(chain.pop());
		} 

		arr.forEach(function(item, i) {
			if (item) {
				//判断为关系参数时，设置条件关系
				if (Relations.indexOf(item) &gt; -1) {
					condition.or = item === Relations[1];
				} else {
					condition = compileConditionStr(item);
					group.push(condition);
				}
			}
		})
	}

	//编译查询条件字符串
	function compileConditionStr(condition) {
		var arr, ignoreNull = false,
			index;

		//判断是否空忽略
		if (condition.charAt(0) === NullIgnoreSign[0]) {
			index = condition.lastIndexOf(NullIgnoreSign[1]);
			if (index &gt; 1) {
				condition = condition.substring(1, index);
				ignoreNull = true;
			} else {
				condition = condition.substring(1);
			}
		}

		arr = condition.split(&#x27; &#x27;).filter(function(item) {
			return item.length &gt; 0;
		});

		return {
			ignoreNull: ignoreNull,
			field: arr[0],
			operation: arr[1],
			param: arr[2]
		};
	}

	//根据过滤条件组生成过滤条件
	function buildConditions(conditions, params) {
		var unit, orGroup, lastOr, or, pass, newGroup, len = conditions.length - 1,
			group = [],
			chain = [group];

		conditions.forEach(function(condition, i) {
			//判断是否pass模式
			if (pass) {
				pass = false;
				lastOr = condition.or;
				return;
			}

			or = condition.or;
			//判断是否为过滤条件组
			if (isArray(condition)) {
				unit = buildConditions(condition, params);
			} else {
				param = condition.param;
				//判断为过滤参数还是过滤值
				if (param.charAt(0) === &#x27;@&#x27;)
					param = st.getObj(params, param.substr(1));

				//判断是否空忽略
				if (condition.ignoreNull &amp;&amp; param == null) {
					or &amp;&amp; (pass = true);
					unit = null;
				} else {
					unit = {
						field: condition.field,
						operation: condition.operation,
						param: param
					};
				}
			}
			if (unit) {
				if (i === len) {
					//最后一个条件和or关系下，将group设置到关系链开始
					if (or)
						group = chain[0];
				} 
				//在上一个和当前关系不一致时
				else if (i &gt; 0 &amp;&amp; !lastOr !== !or) {
					//当前关系为or时，提升or级别，将原有and关系组置于or关系组下
					if (or) {
						//如果存在关系链，在加深一级，否则创建关系链
						if (chain.length &gt; 1) {
							group = chain[0];
							chain = [group];
						} else {
							chain[0] = group = [{
								and: group
							}];
						}
					} else {
						//当前为and时，创建新组，添加到前一个or关系组
						newGroup = [];
						chain.push(newGroup);
						group.push({
							and: newGroup
						});
						group = newGroup;
					}
				}
				group.push(unit);
			}
			if (or)
				orGroup = true;

			lastOr = or;
		})
		group = chain[0];
		if (group.length)
			return orGroup ? {
				or: group
			} : {
				and: group
			};
	}
	//根据条件关系生成过滤方法
	function buildFn(conditions) {
		return function(data) {
			var result = true,
				isOr;
			$.each(conditions, function(relation, condition) {
				if (!checkGroup(data, condition, relation === &#x27;or&#x27;)) {
					result = false;
				}
			})
			return result;
		}
	}

	//验证关系组条件是否匹配
	function checkGroup(data, condistions, isOr) {
		var group, result;
		condistions.some(function(condition, i) {
			if (condition.field) {
				result = compare(data, condition);
			} else {
				if (group = condition.or)
					result = checkGroup(data, group, true);
				else if (group = condition.and)
					result = checkGroup(data, group, false);
			}
			if(isOr &amp;&amp; result)
				return true;
			else if (!isOr &amp;&amp; !result)
				return true;
		})
		return result;
	}

	function getIndex(datas, data) {
		if (data &amp;&amp; datas &amp;&amp; datas.length &amp;&amp; datas.indexOf)
			return datas.indexOf(String(data)) &gt; -1;

		return false;
	}

	function checkStartEnd(datas, data, endOf) {
		if (data &amp;&amp; datas &amp;&amp; datas.length &amp;&amp; datas.substr) {
			data = String(data);
			return (endOf ? datas.substr(datas.length - data.length) : datas.substr(0, data.length)) === data;
		}
		return false;
	}

	/**
	 * 判断操作配置对象
	 * @class Operations
	 */
	var Operations = {
		/**
		 * 非判断，在判断操作符之前加入!,则将判断结果取非
		 * @property {function} ! 
		 * @example
		 * 		//查询name不等于&#x27;roy&#x27;的数据
		 * 		var filter = &quot;name != &#x27;roy&#x27;&quot;
		 */

		/**
		 * 等于判断
		 * @property {function} = 
		 */
		&quot;=&quot;: function(data, param) {
			return data === param;
		},
		/**
		 * 小于判断
		 * @property {function} &lt; 
		 */
		&quot;&lt;&quot;: function(data, param) {
			return data &lt; param;
		},
		/**
		 * 小于等于判断
		 * @property {function} &lt;=
		 */
		&quot;&lt;=&quot;: function(data, param) {
			return data &lt;= param;
		},
		/**
		 * 大于判断
		 * @property {function} &gt;
		 */
		&quot;&gt;&quot;: function(data, param) {
			return data &gt; param;
		},
		/**
		 * 大于等于判断
		 * @property {function} &gt;= 
		 */
		&quot;&gt;=&quot;: function(data, param) {
			return data &gt;= param;
		},
		/**
		 * 参数中包含数据
		 * @property {function} in 
		 */
		&quot;in&quot;: function(data, param) {
			return getIndex(param, data);
		},
		/**
		 * 数据中包含参数
		 * @property {function} like 
		 */
		&quot;like&quot;: getIndex,
		/**
		 * 以参数为开头
		 * @property {function} startOf 
		 */
		&quot;startOf&quot;: checkStartEnd,
		/**
		 * 以参数为结尾
		 * @property {function} endOf 
		 * @example
		 * 		//匹配以&#x27;es&#x27;结尾的name
		 * 		var filter = &quot;name endOf &#x27;es&#x27;&quot;;
		 */
		&quot;endOf&quot;: function(data, param) {
			return checkStartEnd(data, param, true);
		}
	};

	function compare(data, condition) {
		var operation = condition.operation,check,not,result;

		//判断是否为非
		if(operation.charAt(0) === &#x27;!&#x27;){
			not = 1;
			operation = operation.substring(1);
		}

		result = (check = Operations[operation]) ? check(st.getObj(data, condition.field), condition.param) : false;

		return not ? !result : result;
	}

	return {
		filterBuilder: function(filter) {
			return new FilterBuilder(filter);
		},
		/**
		 * 扩展判断操作符,如：&#x27;=&#x27;比较操作符,name = @name
		 * @method extendOperation
		 * @param  {string} operation 操作名称
		 * @param  {function} checkFn   判断方法
		 * @example
		 * 		//添加大于操作符&#x27;&gt;&#x27;
		 * 		st.extendOperation(&#x27;&gt;&#x27;,function(data, param) {
		 * 			//data为数据，param为条件参数
					return data &gt; param;
				});
		 */
		extendOperation : function(operation,checkFn){
			Operations[operation] = checkFn;
		}
	};
})
    </pre>
</div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="../assets/vendor/jquery/jquery-1.8.2.min.js"></script>
<script src="../assets/vendor/bootstrap/js/bootstrap.js"></script>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script src="../assets/js/yuidoc-bootstrap.js"></script>
<script>prettyPrint();</script>
</body>
</html>
