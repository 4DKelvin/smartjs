/*! smart 2015-05-04 */
"use strict";_stDefine("filterBuilder",function(a){function b(a){if(a)switch(typeof a){case"string":this._conditions=d(a);break;case"function":this._filter=a;break;case"object":this._params=a}}function c(b){return function(c){var d=!0;return a.each(b,function(a,b){return c[a]!==b?d=!1:void 0}),d}}function d(a){var b=[],c=0,d=[b];return a.split("(").forEach(function(a,b){0===b?e(d,c,a):a.split(")").forEach(function(a,b){b>0?c--:c++,e(d,c,a)})}),b.length?b:null}function e(a,b,c){var d,e,g,h=a.length-1;e=c.split(/\s(or|and)\s/g),0===e[0].length&&n.indexOf(e[1])>-1&&(e.shift(),a[h].or=e.shift()===n[1]),b>h?d=a[b]=[]:(d=a[b],h>b&&d.push(a.pop())),e.forEach(function(a){a&&(n.indexOf(a)>-1?g.or=a===n[1]:(g=f(a),d.push(g)))})}function f(a){var b,c,d=!1;return a.charAt(0)===m[0]&&(c=a.lastIndexOf(m[1]),c>1?(a=a.substring(1,c),d=!0):a=a.substring(1)),b=a.split(" ").filter(function(a){return a.length>0}),{ignoreNull:d,field:b[0],operation:b[1],param:b[2]}}function g(b,c){var d,e,f,h,i,j,k,l=b.length-1,m=[],n=[m];return b.forEach(function(b,p){return i?(i=!1,void(f=b.or)):(h=b.or,o(b)?d=g(b,c):(k=b.param,"@"===k.charAt(0)&&(k=a.getObj(c,k.substr(1))),b.ignoreNull&&null==k?(h&&(i=!0),d=null):d={field:b.field,operation:b.operation,param:k}),d&&(p===l?h&&(m=n[0]):p>0&&!f!=!h&&(h?n.length>1?(m=n[0],n=[m]):n[0]=m=[{and:m}]:(j=[],n.push(j),m.push({and:j}),m=j)),m.push(d)),h&&(e=!0),void(f=h))}),m=n[0],m.length?e?{or:m}:{and:m}:void 0}function h(b){return function(c){var d=!0;return a.each(b,function(a,b){i(c,b,"or"===a)||(d=!1)}),d}}function i(a,b,c){var d,e;return b.some(function(b){return b.field?e=l(a,b):(d=b.or)?e=i(a,d,!0):(d=b.and)&&(e=i(a,d,!1)),c&&e?!0:c||e?void 0:!0}),e}function j(a,b){return b&&a&&a.length&&a.indexOf?a.indexOf(String(b))>-1:!1}function k(a,b,c){return b&&a&&a.length&&a.substr?(b=String(b),(c?a.substr(a.length-b.length):a.substr(0,b.length))===b):!1}function l(b,c){var d,e,f,g=c.operation;return"!"===g.charAt(0)&&(e=1,g=g.substring(1)),f=(d=p[g])?d(a.getObj(b,c.field),c.param):!1,e?!f:f}var m=["{","}"],n=["and","or"],o=a.isArray;b.prototype={buildCondition:function(a){return this._conditions?g(this._conditions,a):void 0},buildFn:function(d,e){var f,g,i,j,k=this;return k._filter?i=k._filter:k._conditions?(g=this.buildCondition(d),g&&(i=h(g))):e||(i=c(a.mix(d,k._params))),e&&(f=typeof e,"string"===f?j=new b(e).buildFn(d):"function"===f&&(j=e)),a.mergeFn(i,j,!0)}};var p={"=":function(a,b){return a===b},"<":function(a,b){return b>a},"<=":function(a,b){return b>=a},">":function(a,b){return a>b},">=":function(a,b){return a>=b},"in":function(a,b){return j(b,a)},like:j,startOf:k,endOf:function(a,b){return k(a,b,!0)}};return{filterBuilder:function(a){return new b(a)},extendOperation:function(a,b){p[a]=b}}}),_stDefine("dataManager",function(a){function b(b){b._Flow=a.flowController({flow:{buildGetPolicy:function(a,b,c,d){b.buildPolicy(d,c.get)},getData:function(a,b,c,d){var f=i(b,d);return a.__getDone=!0,a.next(e(b,f,d)?"getFromDs":"getFromDm"),f},getFromDm:function(a,b,c,d){var e=a.__getDone?a.result:i(b,d);return d.update||a.end(),e},getFromDs:function(a,b,c,d){var e,f=j(d,c);return f?(e=function(c){d.update!==!1?b.set(h(b,c,d,function(b){a.end().resolve(b)},a.reject)):a.end().resolve(c)},k("search",f,b,d,e,a.reject),a.promise()):void a.end().resolve(i(b,d))},setData:function(a,b,c,d){b.buildPolicy(d,c.set),a.next("ds"===d.way?"setToDs":"setToDm")},setToDm:function(a,b,c,d){return"dm"!==d.way&&a.next("setToDs"),b._innerUpdate(d)},setToDs:function(a,b,c,d){var e,f,g=j(d,c),h=d.pending!==!1;return g&&(h?(e=a.resolve,f=a.reject):a.resolve(data),k("update",g,b,d,e,f),h)?a.promise():void 0}},order:["buildGetPolicy","getData","setData"],trigger:!0})}function c(a,b,c){b&&(a.initPolicy(b,c),!b.get||"get"!==c&&"trigger"!==c||a.initPolicy(b.get,"set"))}function d(a,b){b||(b={});var c=b.success,d=b.error;return b.success=null,b.error=null,{policy:b,success:c,error:d}}function e(a,b,c){return(a.op.checkEmpty||a.checkEmpty)(b,c)}function f(b,c,d){var e=a.Deferred();return a.when(b).done(function(a){c&&c(a),e.resolve(a)}).fail(function(a){d&&d(a),e.resolve(a)}),e.promise()}function g(b,c,d){if(!c._$builded){var e,f,g=c.params;if(s(g)&&(g=c.params=g.apply(null,[b,c])),d&&c.mergeFilter!==!1&&(e=d.params,s(e)&&(e=e.apply(null,[b,c])),g?(f=typeof g,f===typeof e&&"object"===f&&a.mix(g,e)):c.params=e),b._filterMode){var h=d&&d._filterBuilder||r;c.filter=h.buildFn(c.params,c.filter)}c._$builded=!0}}function h(a,b,c,d,e){var f={data:b,filter:c.filter,params:c.params,way:"dm",pending:!1,success:d,error:e};return c.set?(a.buildPolicy(c.set,f),c.set):f}function i(a,b){return a._innerSearch(b)}function j(){for(var a,b,c=arguments,d=c.length,e=0;d>e;e++)if((b=c[e])&&(a=b.dataServices))return a}function k(b,c,d,f,g,h){function i(b){var c=a.mergeMulti(!0,[{},b,f]);return c.success=g,c.error=h,d.setDataSerive(c),c}var j,k,l=0;a.isArray(c)?(k=function(){(j=c[l++])?(j=i(j),j.success=function(a){e(d,a,f)?k():g(a)},p.operate(b,j)):g(data)})():p.operate(b,i(c))}function l(b,c,d,e){if(!c)return d;var f=e.__timers;return __timers||(f=e.__timers={},e.stopTimer=function(b){var c,d=this.__timers;a.isEmptyObject(d)||(b?(c=d[b])&&(d[b]=null,clearInterval(c)):(a.each(d,function(a,b){b&&clearInterval(b)}),this.__timers={}))}),function(){f[b]=setInterval(d,c)}}function m(b,e,h,i){var j,k,e=d(h,e),m=e.policy,n=m.def,o=(m.set,m.position),p=m.delay||0,q=m.timer,r=m.userfulLife;c(h,m,"trigger"),j=m.def?"buildGetPolicy":"get"===o?"getData":"dm"===o?"getFromDm":"getFromDs",r&&("once"===r?k=function(){return!0}:s(r)&&(k=r)),i.on(j,"trigger",function(c,d,h,i,j){var k,o;if(!j){if(n)return void d.buildPolicy(i,m);o=a.mergeObj({mergeFilter:!1,way:"ds"},m),g(d,o,i),k=function(){f(d._Flow.bootWithStart("getData",[d,d.op,o,!0]),e.success,e.error).always(function(a){d.fireHandler("trigger",[a,o])})},setTimeout(l(b,q,k,d),p)}})}var n,o,p,q={ignoreMerges:["params","filter","_filterBuilder"],dmOp:{set:{},get:{}}},r=a.filterBuilder(),s=(a.promiseEvent,a.isFunction);return p=a.factory({name:"dataServices",proto:{operate:function(a,b){var c=this.find(b.dsType);if(c)return"initOptions"!==a&&c.initOptions(b),c[a](b);throw b.dsType+",not defined in dataServices!"},search:function(a){return this.operate("search",a)},update:function(a){return this.operate("update",a)}},base:{search:function(){},update:function(){},initOptions:function(){}}}),n=a.factory({name:"dataManager",type:"class",proto:{create:function(a,b){var c=this.find(a);return c?new c(b):void console.log(a+",not defined in dataManager")}},base:{_filterMode:!0,klassInit:function(d){var e=a.attachTrigger(this);d=e.op=a.mix(d,q.dmOp),c(e,d.get,"get"),c(e,d.set,"set"),b(e),o.applyPolicy(e,e._Flow,d),this.init(d)},init:function(){},get:function(a){var b=this;return a=d(b,a),f(b._Flow.boot(b,b.op,a.policy),a.success,a.error)},set:function(a){var b=this;return a=d(b,a),f(b._Flow.bootWithStart("setData",[b,b.op,a.policy]),a.success,a.error)},_innerSearch:function(){},_innerUpdate:function(){},checkEmpty:function(a){return void 0===a},validate:function(){},clear:function(){},setDataSerive:function(){},initPolicy:function(b){this._filterMode&&(b._filterBuilder=b.filter?a.filterBuilder(b.filter):r)},buildParams:function(a,b){g(this,a,b)},buildPolicy:function(b,c){this.buildParams(b,c),a.mix(b,c,q.ignoreMerges)}}}),o=a.factory({name:"DataPolicyManager",type:"copy",proto:{applyPolicy:function(a,b,c){this.fire("init",[a,b,c])}},base:{init:function(){}}}),o.add("getWay",{init:function(a,b){b.onBefore("getData","checkGetWay",function(a,b,c,d){var e,f=d.way;f&&("ds"===f?e="getFromDs":"dm"===f&&(e="getFromDm"),e&&a.next(e).stop())})}}),o.add("trigger",{init:function(b,c,d){var e=d.get&&d.get.trigger;e&&(a.each(e,function(a,e){m(a,e,b,c,d)}),d.get.trigger=null)}}),{dataManager:n,dataPolicyManager:o,dataServices:p}}),_stDefine("dataManager-table",function(a){function b(a){return q(a)?!0:void console.log("存储的数据不正确！")}function c(a,b,c,d){var e=a.op.crud[b];return c||(c={}),e&&a.buildPolicy(c,e),d||null!=c.updateType||(c.updateType=b),c}function d(a,b){var c,d=b.pageInf,f=a.pageInf;b.update&&!b.updateType&&(b.updateType="find"),b.way||(c=d&&e(d,f,["page","pageSize"])?!0:e(b,a,["order","group"]),c&&(b.way="ds"))}function e(a,b,c){var d,e;return c.some(function(c){return d=a[c],null!=d&&d==b[c]?(e=!0,!0):void 0}),e}function f(a,b){var c,d,e,f;b&&null!=(c=b.params)&&(f=typeof c,"function"!==f&&"object"!==f&&(d=a.getKey())&&(e=c,b.params=c={},c[d]=e))}function g(b,c,d,e){var f,g=e.data;g&&(f=g[d.getField.pageInf])&&(a.mergeObj(d.pageInf,f),e.data=g[d.getField.result])}function h(a,b){a.store(b||[])}function i(a,b){var c=a.$store;q(b)?a.$store=c.concat(b):c.push(b)}function j(b,c,d,e){var f;return b.forEach(function(g,h){return d(g,h)?(e?b[h]=c:a.mergeObj(g,c),f=!0,!1):void 0}),f}function k(a,b,c,d,e){var f,g=a.$store;return g.length&&c.filter&&(f=j(g,b,c.filter,d)),e&&f||i(a,[b]),!0}function l(a,b,c,d,e){var f,g=a.$store,h=a.getKey(),k=0;return g.length&&h?b.forEach(function(b){f=b[h],j(g,b,function(a){return a[h]===f},d)?k++:e&&(k++,i(a,b))}):e&&(i(a,b),k=b.length),k}function m(a,b){var c=a.$store,d=[];return 0===c.length?d:b&&b.filter?(n(c,b,function(a){d.push(a)},!0),d):d.concat(c)}function n(b,c,d,e){var f,g,h,i,j=0,k=b.length;if(0!==k){if(c){if(f=c.filter,!f&&e)return;g=c.pageInf,g&&g.page&&(a.mix(pageinf,s.pageInf),j=(g.page-1)*g.pageSize,j+g.pageSize>k&&(k=j+g.pageSize))}if(f)for(;k>j;j++)i=b[j],f(i,j,b)&&(h=d(i,j,b),null!=h&&(j=h));else for(;k>j;j++)h=d(i,j,b),null!=h&&(j=h)}}function o(a,b){var c,d,e=a.$store,f=0,g=e.length;if(0!==g)return b&&(c=b.filter)?(d=b.preDelete?function(a){p(a,r[3],!0)}:function(a,b){return e.splice(b,1),f++,--b},n(e,b,d,!0)):a.$store=[],f}function p(a,b,c){a[b]=c}var q=a.isArray,r=(a.isPlainObject,["_$new","_$selected","_$updated","_$deleted"]),s={pageInf:{pageSize:20,groupSize:20,page:1,total:0},getField:{pageInf:"pageInf",result:"result"}};a.dataManager.add("DataTable",{init:function(b){var c=this;a.mix(!0,b,s),c.$store=[],b.crud?c.crud.forEach(function(a,b){c.initPolicy(b),b.set&&c.initPolicy(b.set)}):b.crud={},c._Flow.onBefore("setData","handleResult",g)},getKey:function(){return this.op.key},checkEmpty:function(a){return null==a||0===a.length},clear:function(){this.$store=[]},_innerUpdate:function(a){if(a){{var b="replace"===a.updateMode,c=a.updateType,d=(a.filter,this),e=a.data;d.$store,!q(e)}return"find"===c?h(d,e):"insert"===c?i(d,e):"delete"===c?o(d,a):(q(e)?l:k)(d,e,a,b,"save"===c),e}},store:function(a){b(a)&&(this.$store=a)},updateOne:function(a){return a?(f(this,a),this.update(a)):void 0},update:function(a){return c(this,"update",a),this.set(a)},insert:function(a){return c(this,"insert",a),this.set(a)},save:function(a){return c(this,"save",a),this.set(a)},_innerSearch:function(a){return m(this,a)},findOne:function(a){var b;return a?(f(this,a),b=a.success):a={},b&&(a.success=function(a){b(a&&a[0])}),this.find(c(this,"findOne",a,!0))},find:function(a){return c(this,"find",a,!0),d(this.op,a),this.get(a)},removeOne:function(a){return a?(f(this,a),this.remove(a)):void 0},remove:function(a){return this.update(c(this,"remove",a))},findWithStates:function(a){var b=[];return a.forEach(function(a){result[a]=[]}),b=function(b){a.some(function(a){return b[a]?(result[a].push(b),!0):void 0})},result},findByState:function(){},setDataSerive:function(){}})});